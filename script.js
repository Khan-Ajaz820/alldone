const fileInput=document.getElementById("imageUpload"),inputCanvas=document.getElementById("inputCanvas"),inputCtx=inputCanvas.getContext("2d"),outputContainer=document.getElementById("mosaicContainer"),tileSize=8;let imageLoaded=!1;function filenameToEmoji(e){let t=e.toLowerCase().split("/").pop().replace(/^emoji_u/,"").replace(/\.svg$/,"").split("_");return String.fromCodePoint(...t.map(e=>parseInt(e,16)))}async function renderFromResults(e,t,a,n,i=1){outputContainer.innerHTML="";let o=document.getElementById("mosaicCanvas");o||((o=document.createElement("canvas")).id="mosaicCanvas",outputContainer.appendChild(o)),o.width=t*n*4,o.height=a*n*4,o.style.width=t*n+"px",o.style.height=a*n+"px";let r=o.getContext("2d");r.scale(4,4),await document.fonts.load(`${n*i}px NotoEmoji`),r.fillStyle="#000",r.fillRect(0,0,o.width,o.height),r.font=`${n*i}px NotoEmoji`,r.textBaseline="top";let s=(n-n*i)/2,l=0;for(let d=0;d<a;d++)for(let c=0;c<t;c++,l++){let m=e[l]||"⬜";r.fillText(m,c*n+s,d*n+s)}let u=document.getElementById("mosaicModal"),p=document.getElementById("mosaicLoader");u&&(u.classList.add("active"),document.body.style.overflow="hidden"),p&&p.classList.remove("active"),o.style.cursor="pointer",o.addEventListener("click",function(){window.openCanvasLightbox()})}function resetMosaic(){outputContainer.innerHTML="",inputCtx.clearRect(0,0,inputCanvas.width,inputCanvas.height),fileInput.value="",imageLoaded=!1}function downloadUltraHD(){let e=document.getElementById("mosaicCanvas");if(!e)return alert("Please generate the mosaic first!");let t=document.getElementById("downloadUltraHD"),a=t.innerHTML,n=5;t.disabled=!0,t.style.opacity="0.7",t.style.cursor="not-allowed";let i=setInterval(()=>{if(t.innerHTML=`⏳ ${n}s...`,--n<0){clearInterval(i);let o=document.createElement("a");o.download="mosaic-ultra-hd.png",o.href=e.toDataURL("image/png"),o.click(),t.innerHTML=a,t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer"}},1e3)}function downloadStandard(){let e=document.getElementById("mosaicCanvas");if(!e)return alert("Please generate the mosaic first!");let t=document.getElementById("downloadStandard"),a=t.innerHTML,n=5;t.disabled=!0,t.style.opacity="0.7",t.style.cursor="not-allowed";let i=setInterval(()=>{if(t.innerHTML=`⏳ ${n}s...`,--n<0){clearInterval(i);let o=document.createElement("canvas");o.width=.62*e.width,o.height=.62*e.height;let r=o.getContext("2d");r.drawImage(e,0,0,o.width,o.height);let s=document.createElement("a");s.download="mosaic-standard.jpg",s.href=o.toDataURL("image/jpeg",.85),s.click(),t.innerHTML=a,t.disabled=!1,t.style.opacity="1",t.style.cursor="pointer"}},1e3)}!async function e(){try{await loadWasmModule("build/full_mosaic.wasm"),await loadKDTreeIntoWasm("kd_tree.json")}catch(t){console.error("❌ WASM init failed:",t)}}(),fileInput.addEventListener("change",async e=>{let t=e.target.files&&e.target.files[0];if(t)try{let a=await window.preprocessEmojiEnhance(t,{portraitWidth:1080,portraitHeight:1354,toneBrightness:.8,toneRGBA:"rgba(244,233,50,0.26)",unsharpRadius:53,unsharpStrength:2.9,finalFilter:"brightness(1.18) contrast(1.05)",overlaySrc:!0});inputCanvas.width=a.width,inputCanvas.height=a.height,inputCtx.clearRect(0,0,inputCanvas.width,inputCanvas.height),inputCtx.drawImage(a,0,0),imageLoaded=!0,window.wasmReady||(await loadWasmModule("build/full_mosaic.wasm"),await loadKDTreeIntoWasm("kd_tree.json"));let{colors:n,cols:i,rows:o}=calculateTileColorsFromCanvas(inputCanvas,8),r=await matchEmojisInWorker(n);await renderFromResults(r=r.map(filenameToEmoji),i,o,8,.83)}catch(s){console.error("Preprocess/mosaic failed:",s),alert("Could not process image. Please try again.")}}),document.getElementById("downloadUltraHD").addEventListener("click",downloadUltraHD),document.getElementById("downloadStandard").addEventListener("click",downloadStandard);let mosaicWorker=null,workerReady=!1;function initWorker(){mosaicWorker||((mosaicWorker=new Worker("mosaic-worker.js")).onmessage=function(e){let{type:t}=e.data;"WASM_READY"===t&&(workerReady=!0)},mosaicWorker.onerror=function(e){workerReady=!1},mosaicWorker.postMessage({type:"INIT_WASM",data:{wasmPath:"build/full_mosaic.wasm",kdTreePath:"kd_tree.json"}}))}function matchEmojisInWorker(e){return new Promise((t,a)=>{if(!workerReady||!mosaicWorker){try{let n=runMatchingAndGetResults(e);t(n)}catch(i){a(i)}return}let o=function(n){let{type:i,results:r,error:s}=n.data;if("MATCH_COMPLETE"===i&&(mosaicWorker.removeEventListener("message",o),t(r)),"ERROR"===i){mosaicWorker.removeEventListener("message",o),console.error("Worker error, falling back to main thread:",s);try{let l=runMatchingAndGetResults(e);t(l)}catch(d){a(d)}}};mosaicWorker.addEventListener("message",o),mosaicWorker.postMessage({type:"MATCH_EMOJIS",data:{colors:e}})})}initWorker();